@using Quarantine_Management.Function
@using Microsoft.AspNetCore.Http;
@inject IHttpContextAccessor HttpContextAccessor
@{
    DateTime dt = DateTime.Now;
    var Month = dt.ToString("MMMM");
}

<style>
    .container {
        display: block;
        position: relative;
        padding-left: 35px;
        margin-bottom: 12px;
        cursor: pointer;
        font-size: 12px;
        -webkit-user-select: none;
        -moz-user-select: none;
        -ms-user-select: none;
        user-select: none;
    }

    .modal-header {
        background-color: #28a745;
        border-bottom: none;
        padding: 1rem 1.5rem;
        border-radius: 0.5rem 0.5rem 0 0;
    }

    .modal-content {
        border: none;
        border-radius: 0.5rem;
        box-shadow: 0 5px 15px rgba(0,0,0,0.1);
    }




    .required {
        color: #e74c3c;
        margin-left: 0.25rem;
    }

    .btn-submit {
        border: none;
        border-radius: 0.25rem;
        padding: 0.6rem 1.5rem;
        font-weight: 600;
        letter-spacing: 0.5px;
        transition: all 0.3s;
        box-shadow: 0 3px 5px rgba(46, 204, 113, 0.2);
    }

    .modal-body {
        padding: 1.5rem;
    }

    .form-card {
        background-color: #f8f9fa;
        border-radius: 0.5rem;
        padding: 1.5rem;
        margin-bottom: 1.5rem;
        box-shadow: 0 2px 5px rgba(0,0,0,0.05);
        transition: all 0.3s ease;
        display: flex;
        flex-direction: column;
        height: 100%; /* This will make both cards take up the full height of their parent */
    }

    .row {
        display: flex;
        flex-wrap: wrap;
    }

    .col-md-6 {
        display: flex;
        flex-direction: column;
    }

    .form-card:hover {
        box-shadow: 0 5px 15px rgba(0,0,0,0.1);
    }

    .form-card-title {
        font-size: 1rem;
        font-weight: 600;
        color: #333;
        margin-bottom: 1.25rem;
        border-bottom: 2px solid #3dcd58;
        padding-bottom: 0.5rem;
    }


    #manual .select2-container {
        width: 50% !important;
    }

    .input-group {
        display: flex;
        width: 100%;
    }

    .input-group-prepend {
        display: flex;
    }

    .input-group-text {
        display: flex;
        align-items: center;
    }

</style>

<div class="content">
    <div class="container-fluid">
        <div class="row pt-2">
            <div class="col-lg-12 mt-2 mb-2">
                <div class="card">
                    <div class="card-body">
                        <div class="d-flex justify-content-between mb-3">
                            <div class="d-flex">
                                <h2 class="text-dark fw-bold"><i class='fas fa-project-diagram'></i></h2>
                                <h2 class="text-dt fw-bold">&nbsp;Approval Flow</h2>
                            </div>
                            <div>
                                <button class="btn btn-success btn-sm" onclick="addData()">
                                    <i class="fa fa-plus"></i> New Route
                                </button>
                                <button class="btn btn-secondary btn-sm" onclick="DownloadData()">
                                    <i class="fa fa-download"></i> Download Data
                                </button>
                            </div>
                        </div>
                        <div class="row mb-3">
                            <div class="col-lg-1 col-md-1 col-sm-6">
                                <label style="font-size:10pt;"></label>
                                <div>
                                    <button id="btn_apply" name="btn_apply" onclick="applyfilter()" class="btn btn-primary btn-sm btn-block mt-2"><i class="fa fa-search mr-1"></i></button>
                                </div>
                            </div>
                            <div class="col-lg-1 col-md-1 col-sm-6">
                                <label style="font-size:10pt;"></label>
                                <div>
                                    <button id="btn_reset" name="btn_reset" class="btn btn-sm btn-danger btn-block mt-2" onclick="window.location.reload()"><i class="fa fa-history mr-1"></i> </button>
                                </div>
                            </div>
                        </div>
                        <div class="row mt-2">
                            <div class="col-lg-12 col-md-12 col-sm-12">
                                <div id="spinner_loading" class="text-center mt-2">
                                    <i class="fas fa-spinner fa-spin fa-lg" style="font-size:30pt;"></i>
                                </div>
                                <div class="table-responsive" id="table_details" style="overflow-x: auto; white-space: nowrap; scrollbar-width: thin; scroll-behavior: smooth;">
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
<div id="modal_add" class="modal fade" tabindex="-1" role="dialog" data-backdrop="static" data-keyboard="false">
    <div class="modal-dialog modal-lg" role="document">
        <div class="modal-content">
            <div class="modal-header bg-success">
                <h5 class="text-white font-weight-bold">
                    <i class="fa fa-user-plus mr-2"></i>Add New Approver
                </h5>
                <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                    <span aria-hidden="true">&times;</span>
                </button>
            </div>
            <div class="modal-body">
                <div class="row ml-2 mr-2">
                    <div class="col-6">
                        <div class="form-group">
                            <label style="font-size:10pt;font-weight : bold; ">Route Level</label>
                            <input class="form-control form-control-sm text-center" id="levelAdd" style="width:100%;" placeholder="Input Code Level"/>
                        </div>
                    </div>
                    <div class="col-6">
                        <div class="form-group">
                            <label style="font-size:10pt;font-weight : bold;">Route Desc </label>
                            <Input class="form-control form-control-sm text-center" id="routeDescAdd" style="width:100%;" placeholder="Input Route Description"/>

                        </div>
                    </div>

                    <div class="col-12">
                        <label style="font-size:12pt;"></label>
                        <div class="row d-flex justify-content-center">
                            <div class="col-3 mx-auto">
                                <button class="btn btn-success btn-block" id="create_Data"><i class="fas fa-plus"></i> Add Master Data </button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<div id="modal_edit" class="modal fade" tabindex="-1" role="dialog" data-backdrop="static" data-keyboard="false">
    <div class="modal-dialog modal-lg" role="document">
        <div class="modal-content">
            <div class="modal-header bg-success">
                <h5 class="text-white font-weight-bold">
                    <i class="fa fa-user-edit mr-2"></i>Update Data
                </h5>
                <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                    <span aria-hidden="true">&times;</span>
                </button>
            </div>
            <div class="modal-body">
                <div class="row ml-2 mr-2">
                    <div class="col-6">
                        <div class="form-group">
                            <label style="font-size:10pt;font-weight:bold;">Route Level<span style="color: red; font-weight:bold;">*</span></label>
                            <input class="form-control form-control-sm text-center" id="levelEdit" style="width:100%;" placeholder="Input Code Level" />
                        </div>
                    </div>
                    <div class="col-6">
                        <div class="form-group">
                            <label style="font-size:10pt;font-weight:bold;">Route Desc<span style="color: red; font-weight:bold;">*</span></label>
                            <Input class="form-control form-control-sm text-center" id="routeDescEdit" style="width:100%;" placeholder="Input Route Description" />
                        </div>
                    </div>
                    <input type="hidden" id="route_flow" class="form-control form-control-sm" />
                    <div class="col-12">
                        <label style="font-size:12pt;"></label>
                        <div class="text-center mt-3">
                            <button class="btn btn-submit px-4 bg-success text-white" id="update_data">
                                <i class="fas fa-save mr-2"></i> Update
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

@section Scripts {
    <script>
        let isSearch = false;
        var loading = "<div class='text-center'><i class='fa fa-4x fa-spinner fa-spin'></i></div>";
        $(document).ready(function () {
            $.ajax({
                url: "@Url.Action("GetFilterDate")",
                type: "POST",
                success: function (data) {
                    $('#date_from').val(data[0].date_From);
                    $('#date_to').val(data[0].date_To);
                    applyfilter();
                }
            });



            var date_from = $('#date_from').val();
            var date_to = $('#date_to').val();
        });

        function applyfilter() {
            // var sloc = $('#slocFilter option:selected').text();

            $("#table_details").html('');
            var table = $("#table_details");
            var table1 = $("#tbl_details_filter");

            $.ajax({
                url: "@Url.Action("GetAllMasterDataApprovalFlow")",
                type: "Get",
                data: {
                },
                success: function (data) {
                    table.html(data);
                    $("#table_details").attr('hidden', false);
                    $("#table_details #tbl_details_filter").DataTable({
                        "paging": true,
                        "ordering": true,
                        "info": false,
                        "scrollX": false,
                        "searching": true,
                        "lengthChange": true,
                        "fixedHeader": true,
                        "initComplete": function (settings, json) {
                            $("#tbl_details_filter").wrap("<div style='overflow:auto; width:100%;position:relative;'></div>");
                        },
                    });
                },
                complete: function () {
                    $('#spinner_loading').hide();
                }
            });
        }

        function addData() {
            $('#modal_add').modal('show');
        }

        $("#create_Data").click(function () {
            var route_level = $('#levelAdd ').val();
            var route_desc = $('#routeDescAdd ').val();

            if (route_level == '' || route_desc == '') {
                Swal.fire({
                    icon: 'error',
                    title: 'Error',
                    text: 'Please fill in all the required fields!'
                });
            } else {
                Swal.fire({
                    title: 'Add New Approver Data?',
                    text: "Are you sure you want to add this new Approval Flow data?",
                    icon: 'warning',
                    showCancelButton: true,
                    confirmButtonColor: '#28a745',
                    cancelButtonColor: '#dc3545',
                    confirmButtonText: 'Yes!',
                    cancelButtonText: 'No!',
                    showLoaderOnConfirm: true,
                    preConfirm: function () {
                        return new Promise(function (resolve, reject) {
                            $.ajax({
                                type: "POST",
                                async: false,
                                url: "@Url.Action("AddNewApprovalFlow", "Admin")",
                                data: {
                                    route_level: route_level,
                                    route_desc: route_desc
                                },
                                success: function (data) {
                                    if (data.items === 1) {
                                        Swal.fire(
                                            'Added!',
                                            'Approval Flow has been added.',
                                            'success'
                                        );
                                    } else if (data.items === -1) {
                                        Swal.fire(
                                            'Duplicate!',
                                            'Approval Flow already exists.',
                                            'error'
                                        );
                                    }
                                    window.location.href = '@Url.Action("ApprovalRouting", "Admin")';
                                },
                                complete: function () {
                                    $('#spinner_loading').hide();
                                }
                            });
                        });
                    }
                });
            }
        });

        function btn_update(route_flow,route_lvl, route_desc) {
            $('#route_flow').val(route_flow);
            $('#levelEdit').val(route_lvl);
            $('#routeDescEdit').val(route_desc);
            $("#modal_edit").modal("show");
        }
        $("#update_data").click(function () {
            var route_flow = $('#route_flow').val();
            var route_lvl = $('#levelEdit').val();
            var route_desc = $('#routeDescEdit').val();
            if (route_flow == '' || route_lvl == '' || route_desc == '') {
                Swal.fire({
                    icon: 'error',
                    title: 'Error',
                    text: 'Please fill in all the required fields!'
                });
            } else {
                Swal.fire({
                    title: 'Update Approval Data?',
                    text: "Are you sure you want to update this Approval data?",
                    icon: 'warning',
                    showCancelButton: true,
                    confirmButtonColor: '#28a745',
                    cancelButtonColor: '#dc3545',
                    confirmButtonText: 'Yes!',
                    cancelButtonText: 'No!',
                    showLoaderOnConfirm: true,
                    preConfirm: function () {
                        return new Promise(function (resolve, reject) {
                            $.ajax({
                                type: "POST",
                                url: "@Url.Action("UpdateDataApprovalFlow", "Admin")",
                                data: {
                                    route_flow: route_flow,
                                    route_lvl: route_lvl,
                                    route_desc: route_desc
                                },
                                success: function (data) {
                                    console.log("Success response:", data);
                                    if (data.success) {
                                        Swal.fire({
                                            title: 'Updated Successfully!',
                                            text: 'Approval Data Updated Successfully!',
                                            icon: 'success'
                                        }).then(function () {
                                            window.location.href = '@Url.Action("ApprovalRouting", "Admin")';
                                        });
                                    } else {
                                        Swal.fire('Error!', data.message || 'Failed to update the data.', 'error');
                                    }
                                },
                                error: function (xhr, status, error) {
                                    console.error("Error response:", error);
                                    Swal.fire('Error!', 'Failed to update the data. Server error occurred.', 'error');
                                    reject(error);
                                }
                            });
                        });
                    }
                });
            }
        });

        function btn_delete(route_flow) {
            if (route_flow == '') {
                Swal.fire({
                    icon: 'error',
                    title: 'Error',
                    text: 'Please select Approval to delete!'
                });
            } else {
                Swal.fire({
                    title: 'Delete Approval Flow?',
                    text: "Are you sure you want to delete this approval data?",
                    icon: 'warning',
                    showCancelButton: true,
                    confirmButtonColor: '#28a745',
                    cancelButtonColor: '#dc3545',
                    confirmButtonText: 'Yes!',
                    cancelButtonText: 'No!',
                    showLoaderOnConfirm: true,
                    preConfirm: function () {
                        return new Promise(function (resolve, reject) {
                            $.ajax({
                                type: "POST",
                                url: "@Url.Action("DeleteDataApprovalData", "Admin")",
                                data: {
                                    route_flow: route_flow
                                },
                                success: function (response) {
                                    if (response.success) {
                                        Swal.fire({
                                            icon: 'success',
                                            title: 'Success',
                                            text: 'Approval Data deleted successfully!'
                                        }).then(function () {
                                            window.location.reload();
                                        });
                                    } else {
                                        Swal.fire({
                                            icon: 'error',
                                            title: 'Error',
                                            text: response.message || 'Failed to delete Sloc!'
                                        });
                                    }
                                },
                                error: function (xhr, status, error) {
                                    console.error("Delete error:", xhr.responseText);
                                    Swal.fire({
                                        icon: 'error',
                                        title: 'Error',
                                        text: 'An error occurred while deleting the Approver. Please try again.'
                                    });
                                },
                                complete: function () {
                                    $('#spinner_loading').hide();
                                }
                            });
                        });
                    }
                });
            }
        }

        function DownloadData() {
            window.location.href = "@Url.Action("DownloadDataApprovalFlow", "Admin")";
        }

    </script>
}